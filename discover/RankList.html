<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../vender-css/normalize.css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link rel="stylesheet" href="../index.css">
    <link rel="stylesheet" href="../vender-css/rank-list.css">
</head>
<body>
<!--排行榜歌单列表-->
<div id="rank-list">
    <div class="bg-box">
        <div class="g-mn g-mn-l pull-right">
            <div class="g-mnl">
                <div class="g-wrap">
                    <div class="g-content">
                        <!--歌单表头, 歌单信息-->
                        <div class="toplist-header">
                            <div class="cover pull-left">
                                <img src="http://p4.music.126.net/DrRIg6CrgDfVLEph9SNh7w==/18696095720518497.jpg" alt="">
                            </div>
                            <div class="toplist-header-msg pull-left">
                                <h2 class="toplist-name"></h2>
                                <p><i class="fa fa-clock-o"></i> 最近更新：<span>04月11日</span> <i style="font-size: 12px" class="fa-icon update-f">（每天更新）</i></p>
                                <div class="btn-group open">
                                    <a class="btn btn-primary" href="#"><i class="fa fa-play-circle-o"></i> 播放</a>
                                    <a class="btn btn-primary" href="#"><span class="fa fa-plus"></span></a>
                                </div>
                                <a href="#" class="btn btn-default"><i class="fa fa-cube fa-icon"></i><span class="collection"></span></a>
                                <a class="btn btn-default"><i class="fa fa-share-square-o fa-icon"></i><span class="share"></span></a>
                                <a class="btn btn-default"><i class="fa fa-download fa-icon"></i>下载</a>
                                <a class="btn btn-default"><i class="fa fa-commenting-o fa-icon"></i><span class="comment"></span></a>
                            </div>
                        </div>
                        <!--歌单列表-->
                        <div class="g-wrap12">
                            <div class="g-title">
                                <h3>歌曲列表</h3>
                                <p><span class="">0</span>首歌</p>
                                <p>播放: <span>0</span> 次</p>
                            </div>
                            <div class="g-list">
                                <table>
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th class="w2"><div class="wp">标题</div></th>
                                            <th class="w1"><div class="wp">时长</div></th>
                                            <th class="w1"><div class="wp">歌手</div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div id="comment-box">
                                <div class="g-title">
                                    <h3>评论</h3>
                                    <p>共<span class="">134513</span>条评论</p>
                                    <p></p>
                                </div>
                                <div class="m-cmmt">
                                    <div class="iptarea">
                                        <div class="head">
                                            <img src="http://s4.music.126.net/style/web2/img/default/default_avatar.jpg?param=50y50" alt="">
                                        </div>
                                        <div class="m-cmmtipt">
                                            <div class="u-txtwrap">
                                                <textarea class="u-txt area" placeholder="评论"></textarea>
                                                <i class="arrclr"></i>
                                            </div>
                                            <div class="btns">
                                                <i class="fa fa-smile-o fa-lg"></i>
                                                <i class="fa fa-at fa-lg"></i>
                                                <div class="comen-btn">
                                                    <span>140</span>
                                                    <a href="" class="btn btn-primary">评论</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4>最新评论(24132)</h4>
                                        <ul>
                                            <li></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="g-rside pull-left">
            <div class="rank-list-slide">
                <h2>云音乐特色榜</h2>
                <ul class="rank-tese-list">
                </ul>
                <h2>全球媒体榜</h2>
                <ul class="rank-quanqiu-list">
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="../venders-js/jquery-3.2.0.min.js"></script>
<script src="../js/data.js"></script>
<script>
//    排行榜列表
    var topArray
//    接口地址
    var apiUrl = 'http://192.168.1.115:8888/api.php'
    $(function () {
//        更新榜单列表
        updataList()

//          获取URL参数
        var id = getParams('id')
        if (id) {
            for (var i = 0; i < topArray.length; i++) {
                var model = topArray[i]
                if (model.id == id) {
                    listClick(i)
                }
            }
        } else {
//           默认加载第一个歌单数据
            listClick(0)
        }
    })

//      获取url中的参数
    function getParams(name) {
        if (window.location.search) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            console.log(decodeURI(r[2]))
            if (r != null) return decodeURI(r[2]);
        }
    }


    function updataList() {
        topArray = []
        var list = rankList.list
        var teseList = $('.rank-tese-list')             //  特色榜
        var quanqiuList = $('.rank-quanqiu-list')       //  全球榜
        for (var index in list) {
            var topModel = {
                coverImg: list[index].coverImgUrl,   //  榜单图片
                trackCount: list[index].trackCount,  // 榜单歌曲数量
                collectionNum: list[index].subscribedCount,  // 收藏数
                updateTime: list[index].updateTime,          // 更新时间
                playCount: list[index].playCount,           //  收听数
                description: list[index].description,       //  歌单详情描述
                name: list[index].name,                     //  歌单名
                id: list[index].id,                         //  id
                updateFrequency: list[index].updateFrequency,   //  更新周期
            }
//            标签
            var element = '<li> ' +
                    '<div class="left"> ' +
                    '<img src="' + topModel.coverImg + '?param=40y40" alt="">' +
                    ' </div> ' +
                    '<p>' + topModel.name + '</p> ' +
                    '<p>' + topModel.updateFrequency + '</p> ' +
                    '</li>'
            if (index < 4) {        //  特色榜列表
                teseList.append(element)
            } else {                //  全球榜列表
                quanqiuList.append(element)
            }
            topArray.push(topModel)
        }

//        歌单列表的点击方法
        $('.rank-list-slide li').click(function () {
            var index
            if ($(this).parent().hasClass('rank-tese-list')) {
                index = $(this).index()
            } else  {
                index = $(this).index() + 4
            }
            console.log($(this).index())
            listClick(index)
        })
    }

//
    function listClick(index) {
        var model = topArray[index]
//        更新表头
        $('.toplist-name').text(model.name)
//        歌单图片
        $('.cover img').attr('src', model.coverImg)
//        收藏
        var collec = $('.collection')
        collec.text('(' + model.collectionNum + ')')
//        更新日期
        var updatehz = model.updateFrequency
        $('.update-f').text(updatehz)
        console.log(updatehz)
        var update = $('.toplist-header-msg p span')
        update.text(format(model.updateTime))
//        数量
        $('.g-title > p:first span').text(model.trackCount)
//        收听
        $('.g-title > p:last span').text(model.playCount)

        $.ajax({
            type: "GET",
            url: apiUrl,
            data: 'types=playlist&id=' + topArray[index].id,
            dataType : "jsonp",
            success: function(jsonData) {
                console.log(jsonData)
                updataContent(jsonData.result)
            },
            error: function (error) {
                console.log(error)
            }
        })
    }

//    加载歌单列表
    function updataContent(result) {
        var shareNum = result.shareCount            //  分享数
        var commentNum = result.commentCount        //  评论数
        var tracks = result.tracks                  //  歌单列表
        var rankDIV = $('.g-list tbody')            //  歌曲
        //        分享
        var share = $('.share')
        share.text('(' + shareNum + ')')
//        评论
        var comment = $('.comment')
        comment.text('(' + commentNum + ')')

//        TODO  列表切换需要加一个加载等待
//       清空列表
        rankDIV.empty()
//        更新歌单的歌曲列表
        for (var index in tracks) {
            var obj = tracks[index]
//            TODO  歌手排列
            var artists = ''
            for (var num in obj.artists) {
                if (num == 0) {
                    artists += '<a>' + obj.artists[num].name + '</a>'
                } else {
                    artists += '/<a>' + obj.artists[num].name + '</a>'
                }
            }
            var uicon = ''
//            TODO  图标排版仍存在问题
            if (obj.lastRank) {
                if ((parseInt(index) + 1) == parseInt(obj.lastRank)) {
                    uicon = '<i>- 0</i>'
                } else if ((parseInt(index) + 1) > parseInt(obj.lastRank)) {
                    uicon = '<i class="u-icn up-icon"><span>' + ((parseInt(index) + 1) - parseInt(obj.lastRank)) + '</span></i>'
                } else {
                    uicon = '<i class="down-icon u-icn"><span>' + (parseInt(obj.lastRank) - (parseInt(index) + 1)) + '</span></i>'
                }
            } else {
                uicon = '<i class="u-icn new-icon"></i>'
            }
//          标签内容
            var element = ' <tr class="' + ((index % 2 === 0) ? 'even' : '') + '"> ' +
                    '<td class="' + (index < 3 ? 'td-pad1' : '') + '"><div class="g-rank"> ' +
                        '<p class="pull-left">' + (parseInt(index) + 1) + '</p> ' +
                        '<div class="pull-left">' + uicon +'</div> ' +
                        '</div> </td> ' +
                    '<td class="w2 ' + (index < 3 ? 'td-pad2' : '') + '"> ' +
                        '<div class="tt"> ' +
                        '<a class="' + (index < 3 ? '' : 'hidden') + '"><img class="song-pic" src="' + obj.album.picUrl + '" alt=""></a> ' +
                        '<i class="fa fa-play-circle-o "></i> ' +
                        '<div class="song-name"><a href="">' + obj.name + '</a></div> ' +
                    '</div> </td> ' +
                    '<td class="g-msg w1 ' + (index < 3 ? 'td-pad3' : '') + '"> ' +
                        '<p class="g-time">' + compluteTime(obj.duration) +'</p> ' +
                        '<div class="tool-icon"> ' +
                        '<i class="fa fa-plus"></i> ' +
                        '<i class="fa fa-cube fa-icon"></i> ' +
                        '<i class="fa fa-share-square-o fa-icon"></i> ' +
                        '<i class="fa fa-download fa-icon"></i> ' +
                    '</div> </td> ' +
                    '<td class="g-msg w1 ' + (index < 3 ? 'td-pad4' : '') + '"><a>' + obj.artists[num].name + '</a></td> </tr>'
            rankDIV.append(element)
        }
    }

//    计算毫秒为00:00格式
    function compluteTime(seconds) {
        seconds = Math.floor(seconds / 1000)
        var min = Math.floor(seconds / 60),
                second = seconds % 60
        return (add0(min) + ':' + add0(second))
    }

    function add0(m) {
        return m < 10 ? '0' + m : m
    }

//    将时间戳转成日期格式
    function format(shijianchuo) {
    //  shijianchuo是整数，否则要parseInt转换
        var time = new Date(shijianchuo);
        var y = time.getFullYear()
        var m = time.getMonth()+1
        var d = time.getDate()
        var h = time.getHours()
        var mm = time.getMinutes()
        var s = time.getSeconds()
        return add0(m) + '-' + add0(d)
    }

//    两个时间戳的时间差
    function diffTime(t) {
        var date1 = new Date(t);  //开始时间
        var date2 = new Date();    //结束时间
        var date3 = date2.getTime() - date1.getTime()  //时间差的毫秒数
//计算出相差天数
        var days = Math.floor(date3 / (24 * 3600 * 1000))
//计算出小时数
        var leave1 = date3 % (24 * 3600 * 1000)    //计算天数后剩余的毫秒数
        var hours = Math.floor(leave1 / (3600 * 1000))
//计算相差分钟数
        var leave2 = leave1 % (3600 * 1000)        //计算小时数后剩余的毫秒数
        var minutes = Math.floor(leave2 / (60 * 1000))
//计算相差秒数
        var leave3 = leave2 % (60 * 1000)      //计算分钟数后剩余的毫秒数
        var seconds = Math.round(leave3 / 1000)
        console.log(" 相差 " + days + "天" + hours + "小时" + minutes + "分钟" + seconds + "秒")
        return days
    }
</script>
</body>
</html>